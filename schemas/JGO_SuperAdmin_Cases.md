# ЖильеGO — Сценарии использования
## Роль: Супер Админ (Руководитель риелторов)

**Дата:** 26 октября 2025  
**Версия:** 1.0  
**Статус:** ✅ Полная версия

---

## 📋 Содержание

### 0. Роль и права доступа
### 1. Управление риелторами
   - 1.1 Просмотр списка риелторов
   - 1.2 Добавление нового риелтора
   - 1.3 Редактирование данных риелтора
   - 1.4 Деактивация риелтора
   - 1.5 Активация риелтора
### 2. Управление объектами команды
   - 2.1 Просмотр всех объектов риелторов
   - 2.2 Просмотр объектов конкретного риелтора
   - 2.3 Редактирование объектов риелторов
   - 2.4 Модерация новых объектов
### 3. Управление бронированиями команды
   - 3.1 Просмотр всех бронирований
   - 3.2 Просмотр бронирований по риелтору
   - 3.3 Подтверждение/отмена броней
### 4. Аналитика и статистика агентства
   - 4.1 Сводная статистика агентства
   - 4.2 Сравнение риелторов
   - 4.3 ТОП-5 квартир агентства
   - 4.4 ТОП-5 пользователей агентства
   - 4.5 Анализ отмен броней
   - 4.6 Загрузка объектов агентства
### 5. Финансы агентства
   - 5.1 Доходы агентства по периодам
   - 5.2 Доходы по риелторам
   - 5.3 Финансовый отчет агентства
### 6. Экспорт отчетов
   - 6.1 Экспорт в XLSX
   - 6.2 Экспорт в CSV
### 7. Уведомления и алерты
   - 7.1 Уведомления о критических событиях
   - 7.2 Еженедельный отчет

---

## 0. Роль и права доступа

### Определение роли

**Супер Админ** — руководитель агентства недвижимости (риелторской компании), который управляет командой риелторов и имеет полный доступ к данным своих подчиненных.

### Права доступа

**Супер Админ имеет:**
- ✅ Все права обычного Риелтора
- ✅ Просмотр и управление всеми объектами своих риелторов
- ✅ Просмотр всех бронирований своих риелторов
- ✅ Полную аналитику по своему агентству
- ✅ Управление учетными записями риелторов
- ✅ Доступ к финансовой информации агентства

**Супер Админ НЕ имеет:**
- ❌ Доступ к данным других агентств
- ❌ Глобальные административные права (как у Суперпользователя)
- ❌ Возможность изменять системные настройки

### Привязка к агентству

```python
class RealEstateAgency(models.Model):
    """Агентство недвижимости"""
    name = models.CharField(max_length=200)
    description = models.TextField(blank=True)
    phone = models.CharField(max_length=20)
    email = models.EmailField()
    created_at = models.DateTimeField(auto_now_add=True)
    is_active = models.BooleanField(default=True)

class CustomUser(AbstractUser):
    """Расширенная модель пользователя"""
    ROLE_CHOICES = [
        ('guest', 'Гость'),
        ('realtor', 'Риелтор'),
        ('super_admin', 'Супер Админ'),
        ('superuser', 'Суперпользователь'),
    ]
    
    role = models.CharField(max_length=20, choices=ROLE_CHOICES, default='guest')
    agency = models.ForeignKey(RealEstateAgency, on_null=True, blank=True,
                               related_name='employees')
    # Для Супер Админа - это его агентство
    # Для Риелтора - агентство, в котором работает
```

---

## 1. Управление риелторами

### Сценарий 1.1: Просмотр списка риелторов

**Предусловия:**
- Супер Админ авторизован
- Имеет агентство с риелторами

**Основной поток (веб):**

1. Супер Админ заходит в раздел "👥 Мои риелторы"
2. Система показывает список всех риелторов агентства:
   ```
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   
   👥 МОИ РИЕЛТОРЫ
   
   Агентство: "Астана Элит Недвижимость"
   Всего риелторов: 8 (7 активных, 1 неактивный)
   
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   
   [🔍 Поиск риелтора...]  [➕ Добавить]
   
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   
   ┌─────────────────────────────────────┐
   │ 1. ✅ Асем Нурланова               │
   │                                     │
   │ 📱 +7 777 123 4567                  │
   │ 📧 asem@agency.kz                   │
   │ 📍 12 объектов                      │
   │ 💰 890,000₸ в месяц                 │
   │ ⭐ 4.9 (45 отзывов)                 │
   │ 📊 68% загрузка                     │
   │                                     │
   │ В системе: 2 года 3 месяца          │
   │ Статус: 🟢 Активен                  │
   │                                     │
   │ [📊 Статистика] [✏️ Редактировать] │
   └─────────────────────────────────────┘
   
   ┌─────────────────────────────────────┐
   │ 2. ✅ Марат Токаев                 │
   │                                     │
   │ 📱 +7 707 234 5678                  │
   │ 📧 marat@agency.kz                  │
   │ 📍 10 объектов                      │
   │ 💰 720,000₸ в месяц                 │
   │ ⭐ 4.8 (38 отзывов)                 │
   │ 📊 62% загрузка                     │
   │                                     │
   │ В системе: 1 год 8 месяцев          │
   │ Статус: 🟢 Активен                  │
   │                                     │
   │ [📊 Статистика] [✏️ Редактировать] │
   └─────────────────────────────────────┘
   
   ┌─────────────────────────────────────┐
   │ 3. ❌ Данияр Абай (неактивен)      │
   │                                     │
   │ 📱 +7 747 345 6789                  │
   │ 📧 daniyor@agency.kz                │
   │ 📍 3 объекта (заблокированы)        │
   │ 💰 15,000₸ в месяц                  │
   │ ⭐ 4.2 (8 отзывов)                  │
   │                                     │
   │ Деактивирован: 15.10.2025           │
   │ Причина: Низкая активность          │
   │ Статус: 🔴 Неактивен                │
   │                                     │
   │ [🔄 Активировать] [✏️ Редактировать]│
   └─────────────────────────────────────┘
   
   [Показать еще 5...]
   
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   
   Сортировка:
   • По доходу (↓)
   • По объектам
   • По рейтингу
   • По дате добавления
   
   Фильтры:
   [x] Только активные
   [ ] Только неактивные
   [ ] С низкой загрузкой (<40%)
   ```

3. Супер Админ может:
   - Посмотреть детальную статистику риелтора
   - Редактировать данные
   - Активировать/деактивировать
   - Сортировать и фильтровать список

**Основной поток (Telegram):**

1. Супер Админ: `/realtors` или через меню "👥 Риелторы"
2. Бот отправляет список:
   ```
   👥 Ваши риелторы

   Всего: 8 (7 активных)
   
   ━━━━━━━━━━━━━━━━━━━━━━
   
   1. ✅ Асем Нурланова
      💰 890K₸/мес | 📍 12 объектов
      ⭐ 4.9 | 📊 68%
      [Детали] [📊]
   
   2. ✅ Марат Токаев
      💰 720K₸/мес | 📍 10 объектов
      ⭐ 4.8 | 📊 62%
      [Детали] [📊]
   
   3. ❌ Данияр А. (неактивен)
      💰 15K₸/мес | 📍 3 объекта
      ⭐ 4.2 | 🔴
      [Детали] [🔄]
   
   ━━━━━━━━━━━━━━━━━━━━━━
   
   [➕ Добавить риелтора]
   [📊 Сравнить всех]
   [⬅️ Назад]
   ```

**Постусловия:**
- Супер Админ видит полную картину по команде
- Может быстро найти нужного риелтора
- Может перейти к детальной информации

---

### Сценарий 1.2: Добавление нового риелтора

**Предусловия:**
- Супер Админ авторизован
- Имеет права на добавление риелторов

**Основной поток (веб):**

1. Супер Админ в разделе "Риелторы" нажимает "➕ Добавить риелтора"
2. Открывается форма:
   ```
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   
   ➕ ДОБАВИТЬ НОВОГО РИЕЛТОРА
   
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   
   Личные данные:
   
   Имя: *
   [Асем____________________________]
   
   Фамилия: *
   [Нурланова_______________________]
   
   Телефон: *
   [+7 777 123 4567_________________]
   
   Email: *
   [asem.nurlanova@gmail.com________]
   
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   
   Данные для входа:
   
   Логин: *
   [asem.nurlanova__________________]
   (будет использоваться для входа)
   
   Временный пароль: *
   [●●●●●●●●] [👁️ Показать] [🎲 Сгенерировать]
   
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   
   Дополнительно:
   
   Комиссия от бронирований: *
   [10] %
   
   Telegram ID (опционально):
   [@asem_realtor___________________]
   
   Примечание:
   [________________________________]
   [________________________________]
   [________________________________]
   
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   
   ☑️ Отправить данные для входа на email
   ☑️ Отправить инструкцию для новичка
   
   [Отмена] [Сохранить и добавить]
   ```

3. Супер Админ заполняет форму
4. Нажимает "Сохранить и добавить"
5. Система:
   - Создает учетную запись риелтора
   - Генерирует временный пароль (если не указан)
   - Отправляет email с данными для входа
   - Привязывает к агентству Супер Админа

6. Показывает подтверждение:
   ```
   ✅ Риелтор успешно добавлен!
   
   Асем Нурланова добавлена в ваше агентство
   
   Данные для входа отправлены на:
   📧 asem.nurlanova@gmail.com
   
   Логин: asem.nurlanova
   Временный пароль: Qwerty123
   
   При первом входе риелтор должен
   будет сменить пароль.
   
   [OK] [Добавить еще] [К списку]
   ```

**Основной поток (Telegram):**

1. Супер Админ: "➕ Добавить риелтора"
2. Бот запускает пошаговый диалог:
   ```
   ➕ Добавление риелтора

   Шаг 1 из 5
   
   Введите имя риелтора:
   
   [Отмена]
   ```

3. Супер Админ: "Асем"
4. Бот:
   ```
   Шаг 2 из 5
   
   Введите фамилию:
   
   [⬅️ Назад] [Отмена]
   ```

5. Супер Админ: "Нурланова"
6. Бот:
   ```
   Шаг 3 из 5
   
   Введите номер телефона:
   (формат: +7 777 123 4567)
   
   [⬅️ Назад] [Отмена]
   ```

7. И так далее до конца
8. В конце бот показывает:
   ```
   ✅ Риелтор добавлен!
   
   Асем Нурланова
   📱 +7 777 123 4567
   📧 asem@gmail.com
   
   Данные для входа отправлены на email.
   
   [К списку] [Добавить еще]
   ```

**Альтернативные потоки:**

**1a. Email уже занят:**
```
❌ Ошибка добавления

Email asem@gmail.com уже используется
другим пользователем в системе.

Проверьте правильность email или
используйте другой адрес.

[Исправить] [Отмена]
```

**1b. Телефон уже занят:**
```
❌ Ошибка добавления

Телефон +7 777 123 4567 уже привязан
к другому пользователю.

[Исправить] [Отмена]
```

**Постусловия:**
- Новый риелтор создан и привязан к агентству
- Получил данные для входа
- Может начать работу в системе
- Супер Админ может управлять им

---

### Сценарий 1.3: Редактирование данных риелтора

**Предусловия:**
- Супер Админ авторизован
- Риелтор существует в его агентстве

**Основной поток (веб):**

1. Супер Админ выбирает риелтора из списка
2. Нажимает "✏️ Редактировать"
3. Открывается форма редактирования:
   ```
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   
   ✏️ РЕДАКТИРОВАНИЕ РИЕЛТОРА
   
   Асем Нурланова
   ID: #RL-00145 | В системе: 2 года 3 мес
   
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   
   Личные данные:
   
   Имя:
   [Асем____________________________]
   
   Фамилия:
   [Нурланова_______________________]
   
   Телефон:
   [+7 777 123 4567_________________]
   
   Email:
   [asem@agency.kz__________________]
   
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   
   Настройки:
   
   Комиссия от бронирований:
   [10] %
   
   Telegram:
   [@asem_realtor___________________]
   
   Статус:
   [x] Активен
   [ ] Неактивен
   
   Примечание:
   [Отличный риелтор, работает_____]
   [качественно. Высокий рейтинг.___]
   
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   
   Опасная зона:
   
   [🔄 Сбросить пароль]
   [🚫 Деактивировать]
   
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   
   [Отмена] [Сохранить изменения]
   ```

4. Супер Админ вносит изменения
5. Нажимает "Сохранить изменения"
6. Система обновляет данные:
   ```python
   # Обновление данных риелтора
   realtor = get_object_or_404(CustomUser, id=realtor_id, 
                                agency=request.user.agency)
   
   with transaction.atomic():
       realtor.first_name = form.cleaned_data['first_name']
       realtor.last_name = form.cleaned_data['last_name']
       realtor.phone = form.cleaned_data['phone']
       realtor.email = form.cleaned_data['email']
       realtor.save()
       
       # Логируем изменение
       log_admin_action(
           admin=request.user,
           action='EDIT_REALTOR',
           target=realtor,
           changes=get_changes(realtor, form)
       )
   
   messages.success(request, 'Данные риелтора обновлены')
   ```

7. Показывает подтверждение:
   ```
   ✅ Изменения сохранены
   
   Данные Асем Нурлановой обновлены.
   
   [OK] [К списку]
   ```

**Основной поток (Telegram):**

1. Супер Админ выбирает риелтора → "✏️ Редактировать"
2. Бот показывает меню:
   ```
   ✏️ Что изменить?
   
   Риелтор: Асем Нурланова
   
   [📝 Имя и фамилию]
   [📱 Телефон]
   [📧 Email]
   [💼 Комиссию]
   [📝 Примечание]
   
   [⬅️ Назад]
   ```

3. Супер Админ выбирает пункт
4. Вводит новые данные
5. Бот сохраняет и подтверждает

**Альтернативные потоки:**

**1a. Попытка изменить на занятый email:**
```
❌ Не удалось сохранить

Email уже используется другим
пользователем в системе.

[Исправить] [Отмена]
```

**Постусловия:**
- Данные риелтора обновлены
- Изменения залогированы
- Риелтор получил уведомление (если email/телефон изменен)

---

### Сценарий 1.4: Деактивация риелтора

**Предусловия:**
- Супер Админ авторизован
- Риелтор активен

**Основной поток (веб):**

1. Супер Админ выбирает риелтора
2. Нажимает "🚫 Деактивировать"
3. Система показывает предупреждение:
   ```
   ⚠️ ДЕАКТИВАЦИЯ РИЕЛТОРА
   
   Вы собираетесь деактивировать:
   Данияр Абай
   
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   
   Что произойдет:
   
   ❌ Риелтор не сможет войти в систему
   ❌ Его объекты будут скрыты из поиска
   ⚠️ Активные брони останутся (15 броней)
   ℹ️ Данные не будут удалены
   ℹ️ Можно будет активировать позже
   
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   
   Текущие данные:
   • Объектов: 3
   • Активных броней: 15
   • Будущих броней: 8
   • Доход за месяц: 15,000₸
   
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   
   Причина деактивации:
   
   ( ) Низкая активность
   ( ) Плохие отзывы
   ( ) Нарушение правил
   ( ) Уволен
   (*) Другое
   
   Комментарий:
   [Недостаточная активность,_______]
   [малое количество бронирований____]
   
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   
   ☑️ Уведомить риелтора о деактивации
   ☑️ Передать активные брони другому риелтору
   
   Передать брони риелтору:
   [Выберите риелтора ▼]
   • Асем Нурланова
   • Марат Токаев
   • ...
   
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   
   [Отмена] [Деактивировать]
   ```

4. Супер Админ заполняет причину
5. Нажимает "Деактивировать"
6. Система:
   - Деактивирует аккаунт риелтора
   - Скрывает его объекты из поиска
   - Блокирует новые бронирования его объектов
   - Опционально передает активные брони
   - Отправляет уведомление риелтору

7. Показывает результат:
   ```
   ✅ Риелтор деактивирован
   
   Данияр Абай больше не может работать
   в системе.
   
   • 3 объекта скрыты из поиска
   • 15 активных броней переданы Асем Н.
   • Риелтор уведомлен на email
   
   [OK] [К списку]
   ```

**Код деактивации:**

```python
def deactivate_realtor(super_admin, realtor_id, reason, comment, 
                       transfer_to=None):
    """Деактивация риелтора"""
    
    with transaction.atomic():
        realtor = get_object_or_404(
            CustomUser,
            id=realtor_id,
            agency=super_admin.agency,
            role='realtor'
        )
        
        # Деактивируем
        realtor.is_active = False
        realtor.deactivated_at = timezone.now()
        realtor.deactivated_by = super_admin
        realtor.deactivation_reason = reason
        realtor.deactivation_comment = comment
        realtor.save()
        
        # Скрываем объекты
        Property.objects.filter(realtor=realtor).update(
            is_active=False,
            hidden_reason='realtor_deactivated'
        )
        
        # Передаем активные брони
        if transfer_to:
            active_bookings = Booking.objects.filter(
                property__realtor=realtor,
                status__in=['confirmed', 'paid'],
                check_in__gte=timezone.now()
            )
            
            for booking in active_bookings:
                booking.property.realtor = transfer_to
                booking.property.save()
                
                # Уведомляем гостя о смене контакта
                notify_booking_realtor_changed.delay(booking.id)
        
        # Логируем
        log_admin_action(
            admin=super_admin,
            action='DEACTIVATE_REALTOR',
            target=realtor,
            details={
                'reason': reason,
                'comment': comment,
                'properties_count': realtor.properties.count(),
                'transferred_to': transfer_to.id if transfer_to else None
            }
        )
        
        # Уведомляем риелтора
        notify_realtor_deactivated.delay(realtor.id)
    
    return realtor
```

**Основной поток (Telegram):**

Аналогично веб, но более компактно

**Альтернативные потоки:**

**1a. Риелтор уже неактивен:**
```
⚠️ Уже деактивирован

Данияр Абай уже неактивен.
Деактивирован: 15.10.2025

[OK]
```

**1b. Есть неоплаченные брони:**
```
⚠️ Внимание!

У риелтора есть 3 неоплаченных брони
на общую сумму 45,000₸.

Рекомендуем сначала разобраться с ними.

[Все равно деактивировать]
[Отмена]
```

**Постусловия:**
- Риелтор деактивирован
- Не может войти в систему
- Его объекты скрыты
- Активные брони переданы (если выбрано)
- Все действия залогированы

---

### Сценарий 1.5: Активация риелтора

**Предусловия:**
- Супер Админ авторизован
- Риелтор деактивирован

**Основной поток (веб):**

1. Супер Админ выбирает неактивного риелтора
2. Нажимает "🔄 Активировать"
3. Система показывает форму:
   ```
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   
   🔄 АКТИВАЦИЯ РИЕЛТОРА
   
   Данияр Абай
   
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   
   Информация:
   
   Деактивирован: 15.10.2025 (11 дней назад)
   Причина: Низкая активность
   
   При деактивации было:
   • 3 объекта (скрыты)
   • 15 активных броней (переданы)
   
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   
   Что произойдет:
   
   ✅ Риелтор сможет войти в систему
   ✅ Его объекты будут активированы
   ℹ️ Переданные брони останутся у текущих
      риелторов
   
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   
   Комментарий к активации:
   [Обсудили, риелтор готов работать__]
   [активнее. Дали второй шанс.______]
   
   ☑️ Уведомить риелтора об активации
   ☑️ Отправить напоминание о правилах
   
   [Отмена] [Активировать]
   ```

4. Супер Админ нажимает "Активировать"
5. Система активирует риелтора и его объекты
6. Показывает подтверждение:
   ```
   ✅ Риелтор активирован
   
   Данияр Абай снова может работать.
   
   • 3 объекта активированы
   • Риелтор уведомлен на email
   
   [OK] [К списку]
   ```

**Постусловия:**
- Риелтор активирован
- Может войти в систему
- Его объекты снова в поиске

---

## 2. Управление объектами команды

### Сценарий 2.1: Просмотр всех объектов риелторов

**Предусловия:**
- Супер Админ авторизован
- У риелторов агентства есть объекты

**Основной поток (веб):**

1. Супер Админ заходит в "🏠 Объекты команды"
2. Система показывает агрегированный список:
   ```
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   
   🏠 ОБЪЕКТЫ КОМАНДЫ
   
   Агентство: "Астана Элит Недвижимость"
   
   Всего объектов: 67
   • Активных: 62
   • На модерации: 3
   • Неактивных: 2
   
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   
   [🔍 Поиск объекта...] [Фильтры ▼]
   
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   
   Фильтры:
   
   Риелтор: [Все риелторы ▼]
   Статус: [x] Активные [ ] На модерации
          [ ] Неактивные
   Город: [Все города ▼]
   Тип: [Все типы ▼]
   
   Сортировка: [По доходу ↓]
   
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   
   ┌─────────────────────────────────────┐
   │ 🏢 2-комн квартира, ЖК "Триумф"     │
   │                                     │
   │ 📍 Астана, Есиль, ул. Кабанбай 12   │
   │ 💰 25,000₸/сутки                    │
   │ ⭐ 4.9 (28 отзывов)                 │
   │                                     │
   │ 👤 Риелтор: Асем Нурланова          │
   │ 📊 Загрузка: 78% (23/30 дней)       │
   │ 💼 Доход: 575,000₸/мес              │
   │                                     │
   │ Добавлен: 15.01.2024                │
   │ Статус: 🟢 Активен                  │
   │                                     │
   │ [👁️ Просмотр] [✏️ Ред] [📊 Стат]   │
   └─────────────────────────────────────┘
   
   ┌─────────────────────────────────────┐
   │ 🏠 Дом, Коттеджный поселок "Алма"   │
   │                                     │
   │ 📍 Астана, Алматы-2, ул. Жаркент    │
   │ 💰 45,000₸/сутки                    │
   │ ⭐ 4.8 (15 отзывов)                 │
   │                                     │
   │ 👤 Риелтор: Марат Токаев            │
   │ 📊 Загрузка: 65% (19/30 дней)       │
   │ 💼 Доход: 855,000₸/мес              │
   │                                     │
   │ Добавлен: 20.03.2024                │
   │ Статус: 🟢 Активен                  │
   │                                     │
   │ [👁️ Просмотр] [✏️ Ред] [📊 Стат]   │
   └─────────────────────────────────────┘
   
   [Показать еще 10...]
   
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   
   📊 Сводка:
   • Средняя загрузка: 54%
   • Средняя цена: 28,500₸/сутки
   • Общий доход: 4,850,000₸/мес
   
   [📥 Экспорт списка] [📊 Аналитика]
   ```

**Код получения объектов:**

```python
def get_agency_properties(super_admin, filters=None):
    """Получение всех объектов агентства"""
    
    # Базовый запрос - все объекты риелторов агентства
    properties = Property.objects.filter(
        realtor__agency=super_admin.agency
    ).select_related(
        'realtor', 'city', 'district'
    ).prefetch_related(
        'photos', 'reviews'
    )
    
    # Применяем фильтры
    if filters:
        if filters.get('realtor_id'):
            properties = properties.filter(realtor_id=filters['realtor_id'])
        
        if filters.get('status'):
            properties = properties.filter(is_active=filters['status'] == 'active')
        
        if filters.get('city_id'):
            properties = properties.filter(city_id=filters['city_id'])
    
    # Аннотируем статистикой
    properties = properties.annotate(
        monthly_revenue=Coalesce(
            Sum('bookings__total_price',
                filter=Q(bookings__check_in__month=timezone.now().month)),
            Decimal('0')
        ),
        occupancy_rate=Coalesce(
            Count('bookings__id',
                  filter=Q(bookings__status='confirmed',
                          bookings__check_in__month=timezone.now().month)) * 100.0 /
            Extract(timezone.now(), 'day'),
            0.0
        ),
        avg_rating=Avg('reviews__rating')
    )
    
    return properties
```

**Основной поток (Telegram):**

1. Супер Админ: "🏠 Объекты команды"
2. Бот отправляет компактный список:
   ```
   🏠 Объекты команды
   
   Всего: 67 объектов
   Активных: 62
   
   ━━━━━━━━━━━━━━━━━━━━━━
   
   ТОП-5 по доходу:
   
   1. 🏠 Дом "Алма"
      💰 855K₸/мес | 📊 65%
      👤 Марат Т.
      [Детали]
   
   2. 🏢 2-комн "Триумф"
      💰 575K₸/мес | 📊 78%
      👤 Асем Н.
      [Детали]
   
   ...
   
   ━━━━━━━━━━━━━━━━━━━━━━
   
   [🔍 Поиск объекта]
   [📊 Полная статистика]
   [👤 По риелторам]
   [⬅️ Назад]
   ```

**Постусловия:**
- Супер Админ видит все объекты команды
- Может фильтровать и сортировать
- Может перейти к детальной информации

---

### Сценарий 2.2: Просмотр объектов конкретного риелтора

**Предусловия:**
- Супер Админ авторизован
- Выбран конкретный риелтор

**Основной поток (веб):**

1. Супер Админ выбирает риелтора из списка
2. Нажимает "🏠 Объекты" или "Смотреть объекты"
3. Система показывает объекты только этого риелтора:
   ```
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   
   🏠 ОБЪЕКТЫ РИЕЛТОРА
   
   👤 Асем Нурланова
   
   Всего: 12 объектов
   • Активных: 11
   • Неактивных: 1
   
   Общий доход: 890,000₸/мес
   Средняя загрузка: 68%
   
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   
   [Список объектов - аналогично сценарию 2.1]
   
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   ```

**Постусловия:**
- Супер Админ видит объекты конкретного риелтора
- Может анализировать его портфель

---

### Сценарий 2.3: Редактирование объектов риелторов

**Предусловия:**
- Супер Админ авторизован
- Объект существует

**Основной поток:**

Супер Админ может редактировать объекты своих риелторов точно так же, как риелтор редактирует свои собственные объекты (см. сценарий риелтора 1.3).

Все изменения логируются с указанием, что их внес Супер Админ.

---

### Сценарий 2.4: Модерация новых объектов

**Предусловия:**
- Супер Админ авторизован
- Есть объекты на модерации

**Основной поток (веб):**

1. Супер Админ заходит в "📋 Модерация"
2. Видит список объектов на модерации:
   ```
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   
   📋 МОДЕРАЦИЯ ОБЪЕКТОВ
   
   Ожидают проверки: 3
   
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   
   ┌─────────────────────────────────────┐
   │ 🏢 1-комн квартира, ЖК "Сауран"     │
   │                                     │
   │ 📍 Астана, Есиль, ул. Туран 24      │
   │ 💰 20,000₸/сутки                    │
   │                                     │
   │ 👤 Добавил: Алмаз Смагулов          │
   │ 📅 23.10.2025 18:45                 │
   │                                     │
   │ 📸 Фото: 6 шт                       │
   │ 📝 Описание: 485 символов           │
   │                                     │
   │ [👁️ Просмотреть детально]          │
   │ [✅ Одобрить] [❌ Отклонить]        │
   └─────────────────────────────────────┘
   
   [Показать следующий...]
   
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   ```

3. Супер Админ нажимает "👁️ Просмотреть детально"
4. Проверяет все данные объекта:
   - Фотографии (качество, соответствие)
   - Описание (полнота, грамотность)
   - Цену (адекватность рынку)
   - Контактные данные

5. Принимает решение:

**5a. Одобрить:**
```
✅ Одобрить объект?

1-комн квартира, ЖК "Сауран"
Риелтор: Алмаз Смагулов

Объект будет активирован и появится
в поиске.

[Отмена] [✅ Одобрить]
```

После одобрения:
```python
with transaction.atomic():
    property.status = 'active'
    property.is_active = True
    property.moderated_by = super_admin
    property.moderated_at = timezone.now()
    property.save()
    
    # Уведомляем риелтора
    notify_property_approved.delay(property.id)
    
    # Логируем
    log_admin_action(
        admin=super_admin,
        action='APPROVE_PROPERTY',
        target=property
    )
```

**5b. Отклонить:**
```
❌ Отклонить объект?

1-комн квартира, ЖК "Сауран"
Риелтор: Алмаз Смагулов

Укажите причину отклонения:

( ) Некачественные фото
( ) Неполное описание
( ) Неадекватная цена
(*) Другое

Комментарий для риелтора:
[Пожалуйста, добавьте фото кухни и__]
[ванной комнаты. Также укажите этаж._]

[Отмена] [❌ Отклонить]
```

После отклонения:
```python
with transaction.atomic():
    property.status = 'rejected'
    property.is_active = False
    property.rejection_reason = reason
    property.rejection_comment = comment
    property.rejected_by = super_admin
    property.rejected_at = timezone.now()
    property.save()
    
    # Уведомляем риелтора
    notify_property_rejected.delay(property.id)
    
    # Логируем
    log_admin_action(
        admin=super_admin,
        action='REJECT_PROPERTY',
        target=property,
        details={'reason': reason, 'comment': comment}
    )
```

**Постусловия:**
- Объект одобрен или отклонен
- Риелтор получил уведомление
- Действие залогировано

---

## 3. Управление бронированиями команды

### Сценарий 3.1: Просмотр всех бронирований

**Предусловия:**
- Супер Админ авторизован
- У риелторов агентства есть бронирования

**Основной поток (веб):**

1. Супер Админ заходит в "📅 Бронирования команды"
2. Система показывает все бронирования:
   ```
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   
   📅 БРОНИРОВАНИЯ КОМАНДЫ
   
   Агентство: "Астана Элит Недвижимость"
   
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   
   Текущий месяц:
   • Всего: 245 броней
   • Подтверждено: 198
   • Завершено: 180
   • Отменено: 12
   
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   
   [Фильтры ▼]
   
   Период: [Текущий месяц ▼]
   Статус: [Все ▼]
   Риелтор: [Все риелторы ▼]
   Объект: [Все объекты ▼]
   
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   
   ┌─────────────────────────────────────┐
   │ #BR-12458 | 🟢 Подтверждено         │
   │                                     │
   │ 👤 Марат Каримов                    │
   │ 🏢 2-комн "Триумф"                  │
   │ 👨‍💼 Риелтор: Асем Н.                 │
   │                                     │
   │ 📅 25-28 дек (3 ночи)               │
   │ 💰 75,000₸                          │
   │ ✅ Оплачено: 23.12.2025             │
   │                                     │
   │ [Детали] [Отменить]                 │
   └─────────────────────────────────────┘
   
   ┌─────────────────────────────────────┐
   │ #BR-12457 | 🟡 Ожидает оплаты       │
   │                                     │
   │ 👤 Айгуль Смагулова                 │
   │ 🏠 Дом "Алма"                       │
   │ 👨‍💼 Риелтор: Марат Т.                │
   │                                     │
   │ 📅 26-30 дек (4 ночи)               │
   │ 💰 180,000₸                         │
   │ ⏳ Создано: 24.12.2025 19:00        │
   │ ⚠️ Истекает: 25.12.2025 19:00       │
   │                                     │
   │ [Детали] [Подтвердить оплату]       │
   └─────────────────────────────────────┘
   
   [Показать еще 10...]
   
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   
   📊 Итого за период:
   • Общий доход: 4,850,000₸
   • Средний чек: 19,800₸
   • Заполняемость: 54%
   
   [📥 Экспорт] [📊 Аналитика]
   ```

**Постусловия:**
- Супер Админ видит все бронирования агентства
- Может фильтровать по различным критериям
- Может перейти к деталям или действиям

---

### Сценарий 3.2: Просмотр бронирований по риелтору

**Предусловия:**
- Супер Админ авторизован
- Выбран конкретный риелтор

**Основной поток:**

Аналогично сценарию 3.1, но с фильтром по конкретному риелтору.

---

### Сценарий 3.3: Подтверждение/отмена броней

**Предусловия:**
- Супер Админ авторизован
- Бронирование существует

**Основной поток:**

Супер Админ может подтверждать оплату или отменять бронирования точно так же, как это делает риелтор (см. сценарии риелтора 2.2 и 2.3).

Все действия логируются с указанием, что их выполнил Супер Админ.

---

## 4. Аналитика и статистика агентства

### Сценарий 4.1: Сводная статистика агентства

**Предусловия:**
- Супер Админ авторизован

**Основной поток (веб):**

1. Супер Админ заходит на главную или в раздел "📊 Статистика"
2. Система показывает дашборд:
   ```
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   
   📊 ДАШБОРД АГЕНТСТВА
   
   Агентство: "Астана Элит Недвижимость"
   Период: Текущий месяц (октябрь 2025)
   
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   
   💰 ФИНАНСЫ
   
   ┌──────────────┬──────────────┬──────────────┐
   │ Общий доход  │ Рост         │ Прогноз      │
   ├──────────────┼──────────────┼──────────────┤
   │ 4,850,000₸   │ +12.5% ↑     │ 5,100,000₸   │
   └──────────────┴──────────────┴──────────────┘
   
   График дохода:
   
        5.0M ┤                          ╭─
        4.5M ┤                    ╭─────╯
        4.0M ┤               ╭────╯
        3.5M ┤          ╭────╯
        3.0M ┤     ╭────╯
        2.5M ┤─────╯
             └─┬────┬────┬────┬────┬────┬──>
              Май  Июн  Июл  Авг  Сен  Окт
   
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   
   📊 БРОНИРОВАНИЯ
   
   ┌──────────┬──────────┬──────────┬──────────┐
   │ Всего    │ Активные │ Завершено│ Отменено │
   ├──────────┼──────────┼──────────┼──────────┤
   │   245    │    65    │   180    │    12    │
   │          │  +8.3%   │  +10.2%  │  -2.1%   │
   └──────────┴──────────┴──────────┴──────────┘
   
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   
   🏠 ОБЪЕКТЫ
   
   ┌──────────────┬───────────────┬─────────────┐
   │ Всего        │ Загрузка      │ Средний рейт│
   ├──────────────┼───────────────┼─────────────┤
   │ 67 объектов  │ 54% (↑ 3.2%)  │ ⭐ 4.7     │
   └──────────────┴───────────────┴─────────────┘
   
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   
   👥 РИЕЛТОРЫ
   
   ┌──────────┬────────────┬──────────────┐
   │ Активных │ Лучший     │ Средний доход│
   ├──────────┼────────────┼──────────────┤
   │    7     │ Асем Н.    │   606,250₸   │
   │          │ 890K₸/мес  │   (+5.8%)    │
   └──────────┴────────────┴──────────────┘
   
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   
   🎯 КЛЮЧЕВЫЕ МЕТРИКИ
   
   • Конверсия бронирований: 68.5% (↑)
   • Повторные бронирования: 23% (↑)
   • Средний чек: 19,800₸ (↑)
   • Средняя длительность: 3.2 ночи
   • Отмены по вине гостя: 8 (↓)
   • Отмены по вине агентства: 4
   
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   
   ⚠️ ТРЕБУЕТ ВНИМАНИЯ
   
   • Ержан А.: доход ниже среднего на 36%
   • Квартира #PR-234: 0 броней за месяц
   • 3 объекта: рейтинг ниже 4.0
   
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   
   [Детальные отчеты] [Сравнить с прошлым периодом]
   ```

**Код для дашборда:**

```python
def get_agency_dashboard(super_admin, period='current_month'):
    """Получение данных для дашборда агентства"""
    
    agency = super_admin.agency
    
    # Определяем период
    if period == 'current_month':
        start_date = timezone.now().replace(day=1, hour=0, minute=0)
        end_date = timezone.now()
    elif period == 'last_month':
        # логика для прошлого месяца
        pass
    
    # Получаем всех риелторов агентства
    realtors = CustomUser.objects.filter(
        agency=agency,
        role='realtor'
    )
    
    # Получаем все объекты агентства
    properties = Property.objects.filter(
        realtor__agency=agency
    )
    
    # Получаем все бронирования агентства за период
    bookings = Booking.objects.filter(
        property__realtor__agency=agency,
        created_at__gte=start_date,
        created_at__lte=end_date
    )
    
    # Рассчитываем метрики
    total_revenue = bookings.filter(
        status__in=['paid', 'completed']
    ).aggregate(
        total=Coalesce(Sum('total_price'), Decimal('0'))
    )['total']
    
    total_bookings = bookings.count()
    active_bookings = bookings.filter(status='confirmed').count()
    completed_bookings = bookings.filter(status='completed').count()
    cancelled_bookings = bookings.filter(status='cancelled').count()
    
    # Средний чек
    avg_booking_price = bookings.filter(
        status__in=['paid', 'completed']
    ).aggregate(
        avg=Coalesce(Avg('total_price'), Decimal('0'))
    )['avg']
    
    # Загрузка объектов
    total_nights = (end_date - start_date).days * properties.count()
    booked_nights = bookings.filter(
        status__in=['confirmed', 'completed']
    ).aggregate(
        total=Coalesce(
            Sum(F('check_out') - F('check_in')),
            timezone.timedelta(0)
        )
    )['total'].days
    
    occupancy_rate = (booked_nights / total_nights * 100) if total_nights > 0 else 0
    
    # Лучший риелтор
    best_realtor = realtors.annotate(
        revenue=Coalesce(
            Sum('properties__bookings__total_price',
                filter=Q(properties__bookings__status__in=['paid', 'completed'],
                        properties__bookings__created_at__gte=start_date,
                        properties__bookings__created_at__lte=end_date)),
            Decimal('0')
        )
    ).order_by('-revenue').first()
    
    # Средний доход риелтора
    avg_realtor_revenue = realtors.annotate(
        revenue=Coalesce(
            Sum('properties__bookings__total_price',
                filter=Q(properties__bookings__status__in=['paid', 'completed'],
                        properties__bookings__created_at__gte=start_date,
                        properties__bookings__created_at__lte=end_date)),
            Decimal('0')
        )
    ).aggregate(avg=Avg('revenue'))['avg'] or Decimal('0')
    
    # Средний рейтинг
    avg_rating = properties.aggregate(
        avg=Avg('reviews__rating')
    )['avg'] or 0
    
    # Проблемные зоны
    low_performing_realtors = realtors.annotate(
        revenue=Coalesce(
            Sum('properties__bookings__total_price',
                filter=Q(properties__bookings__status__in=['paid', 'completed'],
                        properties__bookings__created_at__gte=start_date,
                        properties__bookings__created_at__lte=end_date)),
            Decimal('0')
        )
    ).filter(
        revenue__lt=avg_realtor_revenue * Decimal('0.7')  # Ниже 70% от среднего
    )
    
    zero_bookings_properties = properties.annotate(
        bookings_count=Count('bookings',
                            filter=Q(bookings__created_at__gte=start_date,
                                    bookings__created_at__lte=end_date))
    ).filter(bookings_count=0)
    
    low_rated_properties = properties.annotate(
        avg_rating=Avg('reviews__rating')
    ).filter(avg_rating__lt=4.0)
    
    return {
        'period': {
            'start': start_date,
            'end': end_date,
            'label': 'Текущий месяц'
        },
        'finance': {
            'total_revenue': total_revenue,
            'growth': 12.5,  # Нужно рассчитывать сравнением с прошлым периодом
            'forecast': total_revenue * Decimal('1.05')
        },
        'bookings': {
            'total': total_bookings,
            'active': active_bookings,
            'completed': completed_bookings,
            'cancelled': cancelled_bookings,
            'avg_price': avg_booking_price
        },
        'properties': {
            'total': properties.count(),
            'occupancy_rate': round(occupancy_rate, 1),
            'avg_rating': round(avg_rating, 1)
        },
        'realtors': {
            'active_count': realtors.filter(is_active=True).count(),
            'best_realtor': best_realtor,
            'avg_revenue': avg_realtor_revenue
        },
        'alerts': {
            'low_performing_realtors': low_performing_realtors,
            'zero_bookings_properties': zero_bookings_properties,
            'low_rated_properties': low_rated_properties
        }
    }
```

**Основной поток (Telegram):**

1. Супер Админ: "📊 Статистика"
2. Бот отправляет краткую сводку:
   ```
   📊 Статистика агентства
   
   Текущий месяц:
   
   💰 Доход: 4,850,000₸
   📈 Рост: +12.5%
   
   📅 Бронирования: 245
   ✅ Завершено: 180
   ❌ Отменено: 12
   
   🏠 Объекты: 67
   📊 Загрузка: 54%
   ⭐ Рейтинг: 4.7
   
   👥 Риелторы: 7 активных
   🏆 Лучший: Асем Н. (890K₸)
   
   ━━━━━━━━━━━━━━━━━━━━━━
   
   [📊 Детальная статистика]
   [👥 По риелторам]
   [🏠 По объектам]
   [📥 Экспорт]
   [⬅️ Назад]
   ```

**Постусловия:**
- Супер Админ получил полную картину работы агентства
- Видит ключевые метрики и тренды
- Может перейти к детальной аналитике

---

### Сценарий 4.2: Сравнение риелторов

**Предусловия:**
- Супер Админ авторизован
- У агентства есть несколько риелторов

**Основной поток (веб):**

1. Супер Админ в разделе "Статистика" нажимает "👥 Сравнить риелторов"
2. Система показывает сравнительную таблицу:
   ```
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   
   👥 СРАВНЕНИЕ РИЕЛТОРОВ
   
   Период: [Текущий месяц ▼]
   
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   
   ┌────┬──────────┬─────────┬──────┬──────┬────────┬────────┐
   │ №  │ Риелтор  │ Объектов│ Брон.│ Доход│ Рейтинг│ Загр.  │
   ├────┼──────────┼─────────┼──────┼──────┼────────┼────────┤
   │ 1  │ Асем Н.  │   12    │  45  │ 890k │  4.9⭐ │  68%   │
   ├────┼──────────┼─────────┼──────┼──────┼────────┼────────┤
   │ 2  │ Марат Т. │   10    │  38  │ 720k │  4.8⭐ │  62%   │
   ├────┼──────────┼─────────┼──────┼──────┼────────┼────────┤
   │ 3  │ Алмаз С. │   10    │  42  │ 680k │  4.7⭐ │  55%   │
   ├────┼──────────┼─────────┼──────┼──────┼────────┼────────┤
   │ 4  │ Айгуль С.│    9    │  35  │ 590k │  4.5⭐ │  51%   │
   ├────┼──────────┼─────────┼──────┼──────┼────────┼────────┤
   │ 5  │ Нурлан К.│    7    │  30  │ 485k │  4.4⭐ │  48%   │
   ├────┼──────────┼─────────┼──────┼──────┼────────┼────────┤
   │ 6  │ Гульнара │    6    │  28  │ 410k │  4.6⭐ │  52%   │
   ├────┼──────────┼─────────┼──────┼──────┼────────┼────────┤
   │ 7  │ Ержан А. │    5    │  25  │ 385k │  4.3⭐ │  45%   │
   └────┴──────────┴─────────┴──────┴──────┴────────┴────────┘
   
   ИТОГО:  67      245    4,850k    4.7⭐   54%
   Среднее: 9.6    35.0    693k     4.6⭐   54%
   
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   
   📊 ВИЗУАЛИЗАЦИЯ
   
   Доход по риелторам:
   
   Асем Н.   ████████████████████ 890k
   Марат Т.  ████████████████░░░░ 720k
   Алмаз С.  ███████████████░░░░░ 680k
   Айгуль С. █████████████░░░░░░░ 590k
   Нурлан К. ███████████░░░░░░░░░ 485k
   Гульнара  █████████░░░░░░░░░░░ 410k
   Ержан А.  ████████░░░░░░░░░░░░ 385k
   
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   
   💡 ИНСАЙТЫ
   
   🏆 Лучший риелтор: Асем Нурланова
      • Самый высокий доход
      • Лучший рейтинг
      • Максимальная загрузка
   
   ⚠️ Требует внимания: Ержан Абдуллин
      • Доход ниже среднего на 44%
      • Загрузка ниже среднего
      • Рекомендуем провести обучение
   
   📈 Рост: Айгуль Смагулова
      • +18% к прошлому месяцу
      • Набирает темп
   
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   
   [📥 Экспорт сравнения]
   [📊 Детали по каждому]
   [⬅️ Назад]
   ```

**Код сравнения:**

```python
def compare_realtors(super_admin, period='current_month'):
    """Сравнение риелторов агентства"""
    
    # Определяем период
    start_date, end_date = get_period_dates(period)
    
    # Получаем риелторов с метриками
    realtors = CustomUser.objects.filter(
        agency=super_admin.agency,
        role='realtor'
    ).annotate(
        # Количество объектов
        properties_count=Count('properties', distinct=True),
        
        # Количество бронирований
        bookings_count=Count('properties__bookings',
                            filter=Q(properties__bookings__created_at__gte=start_date,
                                    properties__bookings__created_at__lte=end_date),
                            distinct=True),
        
        # Доход
        revenue=Coalesce(
            Sum('properties__bookings__total_price',
                filter=Q(properties__bookings__status__in=['paid', 'completed'],
                        properties__bookings__created_at__gte=start_date,
                        properties__bookings__created_at__lte=end_date)),
            Decimal('0')
        ),
        
        # Средний рейтинг
        avg_rating=Coalesce(
            Avg('properties__reviews__rating'),
            Decimal('0')
        ),
        
        # Загрузка
        total_nights=Count('properties', distinct=True) * (end_date - start_date).days,
        booked_nights=Coalesce(
            Sum(
                ExpressionWrapper(
                    F('properties__bookings__check_out') - F('properties__bookings__check_in'),
                    output_field=DurationField()
                ),
                filter=Q(properties__bookings__status__in=['confirmed', 'completed'],
                        properties__bookings__created_at__gte=start_date,
                        properties__bookings__created_at__lte=end_date)
            ),
            timezone.timedelta(0)
        )
    ).annotate(
        occupancy_rate=Case(
            When(total_nights=0, then=Value(0.0)),
            default=ExpressionWrapper(
                F('booked_nights') * 100.0 / F('total_nights'),
                output_field=FloatField()
            ),
            output_field=FloatField()
        )
    ).order_by('-revenue')
    
    # Рассчитываем средние значения
    aggregates = realtors.aggregate(
        avg_properties=Avg('properties_count'),
        avg_bookings=Avg('bookings_count'),
        avg_revenue=Avg('revenue'),
        avg_rating=Avg('avg_rating'),
        avg_occupancy=Avg('occupancy_rate'),
        total_revenue=Sum('revenue')
    )
    
    # Определяем лучших и худших
    best_realtor = realtors.first()
    worst_realtor = realtors.last()
    
    # Находим растущих (нужно сравнение с прошлым периодом)
    # Упрощенно - можно добавить логику
    
    return {
        'realtors': realtors,
        'aggregates': aggregates,
        'best': best_realtor,
        'worst': worst_realtor,
        'period': {
            'start': start_date,
            'end': end_date
        }
    }
```

**Постусловия:**
- Супер Админ видит сравнительную эффективность риелторов
- Может выявить лидеров и аутсайдеров
- Может принять решения о мотивации/обучении

---

### Сценарий 4.3: ТОП-5 квартир агентства

**Предусловия:**
- Супер Админ авторизован
- У агентства есть объекты с бронированиями

**Основной поток (веб):**

1. Супер Админ в разделе "Статистика" выбирает "🏆 ТОП-5 квартир"
2. Система показывает два варианта:
   ```
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   
   🏆 ТОП-5 КВАРТИР АГЕНТСТВА
   
   Период: [Текущий месяц ▼]
   
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   
   [💰 По доходу] [📅 По числу бронирований]
   
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   
   🥇 ПО ДОХОДУ
   
   ┌─────────────────────────────────────┐
   │ 1. 🏠 Дом "Алма" - 855,000₸         │
   │                                     │
   │ 📍 Астана, Алматы-2                 │
   │ 👨‍💼 Риелтор: Марат Токаев            │
   │                                     │
   │ 💰 45,000₸/сутки                    │
   │ 📅 19 броней (57 ночей)             │
   │ 📊 Загрузка: 65%                    │
   │ ⭐ 4.8 (15 отзывов)                 │
   │                                     │
   │ [Детали] [Календарь]                │
   └─────────────────────────────────────┘
   
   ┌─────────────────────────────────────┐
   │ 2. 🏢 2-комн "Триумф" - 575,000₸    │
   │                                     │
   │ 📍 Астана, Есиль                    │
   │ 👨‍💼 Риелтор: Асем Нурланова          │
   │                                     │
   │ 💰 25,000₸/сутки                    │
   │ 📅 23 брони (69 ночей)              │
   │ 📊 Загрузка: 78%                    │
   │ ⭐ 4.9 (28 отзывов)                 │
   │                                     │
   │ [Детали] [Календарь]                │
   └─────────────────────────────────────┘
   
   [Показать 3-5 места...]
   
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   
   📊 Эти 5 квартир приносят 35% общего
   дохода агентства (1,695,000₸ из 4,850,000₸)
   
   [📥 Экспорт ТОПа] [📊 Полная статистика]
   ```

**Код для ТОП-5:**

```python
def get_top_properties(super_admin, period='current_month', order_by='revenue'):
    """Получение ТОП-5 квартир агентства"""
    
    start_date, end_date = get_period_dates(period)
    
    # Базовый запрос
    properties = Property.objects.filter(
        realtor__agency=super_admin.agency
    ).select_related(
        'realtor', 'city', 'district'
    ).annotate(
        # Доход
        revenue=Coalesce(
            Sum('bookings__total_price',
                filter=Q(bookings__status__in=['paid', 'completed'],
                        bookings__created_at__gte=start_date,
                        bookings__created_at__lte=end_date)),
            Decimal('0')
        ),
        
        # Количество бронирований
        bookings_count=Count('bookings',
                            filter=Q(bookings__created_at__gte=start_date,
                                    bookings__created_at__lte=end_date),
                            distinct=True),
        
        # Количество ночей
        total_nights_booked=Coalesce(
            Sum(
                ExpressionWrapper(
                    F('bookings__check_out') - F('bookings__check_in'),
                    output_field=DurationField()
                ),
                filter=Q(bookings__status__in=['confirmed', 'completed'],
                        bookings__created_at__gte=start_date,
                        bookings__created_at__lte=end_date)
            ),
            timezone.timedelta(0)
        ),
        
        # Загрузка
        period_days=(end_date - start_date).days,
        occupancy_rate=Case(
            When(period_days=0, then=Value(0.0)),
            default=ExpressionWrapper(
                Extract(F('total_nights_booked'), 'day') * 100.0 / F('period_days'),
                output_field=FloatField()
            ),
            output_field=FloatField()
        ),
        
        # Средний рейтинг
        avg_rating=Coalesce(Avg('reviews__rating'), Decimal('0'))
    )
    
    # Сортировка
    if order_by == 'revenue':
        properties = properties.order_by('-revenue')
    elif order_by == 'bookings':
        properties = properties.order_by('-bookings_count')
    
    # Берем ТОП-5
    top_5 = properties[:5]
    
    # Рассчитываем долю в общем доходе
    total_agency_revenue = Property.objects.filter(
        realtor__agency=super_admin.agency
    ).aggregate(
        total=Coalesce(
            Sum('bookings__total_price',
                filter=Q(bookings__status__in=['paid', 'completed'],
                        bookings__created_at__gte=start_date,
                        bookings__created_at__lte=end_date)),
            Decimal('0')
        )
    )['total']
    
    top_5_revenue = sum(p.revenue for p in top_5)
    share_percentage = (top_5_revenue / total_agency_revenue * 100) if total_agency_revenue > 0 else 0
    
    return {
        'top_5': top_5,
        'total_revenue': total_agency_revenue,
        'top_5_revenue': top_5_revenue,
        'share_percentage': round(share_percentage, 1),
        'order_by': order_by
    }
```

**Постусловия:**
- Супер Админ видит самые прибыльные или популярные объекты
- Может анализировать что работает лучше
- Может принять решения о масштабировании успешных моделей

---

### Сценарий 4.4: ТОП-5 пользователей агентства

**Предусловия:**
- Супер Админ авторизован
- У агентства есть пользователи с бронированиями

**Основной поток (веб):**

1. Супер Админ выбирает "🏆 ТОП-5 гостей"
2. Система показывает:
   ```
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   
   🏆 ТОП-5 ГОСТЕЙ АГЕНТСТВА
   
   Период: [За все время ▼] [Текущий год ▼]
   
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   
   [🏠 По заселениям] [💰 По тратам]
   
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   
   🥇 ПО КОЛИЧЕСТВУ ЗАСЕЛЕНИЙ
   
   ┌─────────────────────────────────────┐
   │ 1. 👤 Марат Каримов                │
   │                                     │
   │ 📱 +7 777 123 4567                  │
   │ 📧 marat.k@email.kz                 │
   │                                     │
   │ 🏠 Бронирований: 18                 │
   │ 💰 Всего потрачено: 450,000₸        │
   │ ⭐ Средняя оценка: 4.9              │
   │ 📅 С нами с: 15.03.2024             │
   │                                     │
   │ Последнее бронирование:             │
   │ 2-комн "Триумф" - 23.12.2025        │
   │                                     │
   │ [История] [Профиль]                 │
   └─────────────────────────────────────┘
   
   ┌─────────────────────────────────────┐
   │ 2. 👤 Айгуль Смагулова             │
   │                                     │
   │ 📱 +7 707 234 5678                  │
   │ 📧 aigul.s@email.kz                 │
   │                                     │
   │ 🏠 Бронирований: 15                 │
   │ 💰 Всего потрачено: 380,000₸        │
   │ ⭐ Средняя оценка: 4.8              │
   │ 📅 С нами с: 20.04.2024             │
   │                                     │
   │ [История] [Профиль]                 │
   └─────────────────────────────────────┘
   
   [Показать 3-5 места...]
   
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   
   💡 Эти 5 гостей принесли 27% дохода
   (1,309,500₸ из 4,850,000₸)
   
   [📥 Экспорт] [📊 Детальная аналитика]
   ```

**Постусловия:**
- Супер Админ видит самых ценных гостей
- Может разработать программы лояльности
- Может персонализировать предложения

---

### Сценарий 4.5: Анализ отмен броней

**Предусловия:**
- Супер Админ авторизован
- Были отмененные бронирования

**Основной поток (веб):**

1. Супер Админ выбирает "❌ Анализ отмен"
2. Система показывает:
   ```
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   
   ❌ АНАЛИЗ ОТМЕН БРОНЕЙ
   
   Период: [Текущий месяц ▼]
   
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   
   📊 ОБЩАЯ СТАТИСТИКА
   
   Всего отменено: 12 броней
   % от общего: 4.9% (норма: до 10%)
   
   По инициатору:
   • Гость: 8 (66.7%)
   • Агентство: 4 (33.3%)
   
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   
   📋 ПРИЧИНЫ ОТМЕН (ГОСТИ)
   
   ┌─────────────────────────────┬───────┐
   │ Причина                     │ Кол-во│
   ├─────────────────────────────┼───────┤
   │ Изменились планы            │   3   │
   │ Нашли дешевле               │   2   │
   │ Отменилась поездка          │   2   │
   │ Не устроили условия         │   1   │
   │ Другое                      │   0   │
   └─────────────────────────────┴───────┘
   
   Диаграмма:
   
   Изменились планы    ███████░░░ 37.5%
   Нашли дешевле       █████░░░░░ 25.0%
   Отменилась поездка  █████░░░░░ 25.0%
   Не устроили условия ██░░░░░░░░ 12.5%
   
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   
   📋 ПРИЧИНЫ ОТМЕН (АГЕНТСТВО)
   
   ┌─────────────────────────────┬───────┐
   │ Причина                     │ Кол-во│
   ├─────────────────────────────┼───────┤
   │ Технические проблемы        │   2   │
   │ Двойное бронирование        │   1   │
   │ Недоступность объекта       │   1   │
   └─────────────────────────────┴───────┘
   
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   
   💡 РЕКОМЕНДАЦИИ
   
   ⚠️ Высокая доля отмен из-за цены
   → Рекомендуем проанализировать
     ценообразование
   
   ⚠️ Есть случаи двойного бронирования
   → Проверьте синхронизацию календарей
   
   ⚠️ 1 отмена из-за несоответствия условиям
   → Улучшите описания объектов
   
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   
   📅 ДЕТАЛИ ПО ОТМЕНЕННЫМ БРОНЯМ
   
   [Список отмененных броней с деталями]
   
   [📥 Экспорт отчета] [⬅️ Назад]
   ```

**Код анализа отмен:**

```python
def analyze_cancellations(super_admin, period='current_month'):
    """Анализ отмененных броней агентства"""
    
    start_date, end_date = get_period_dates(period)
    
    # Все отмененные брони
    cancelled_bookings = Booking.objects.filter(
        property__realtor__agency=super_admin.agency,
        status='cancelled',
        cancelled_at__gte=start_date,
        cancelled_at__lte=end_date
    ).select_related(
        'property', 'user', 'property__realtor'
    )
    
    total_bookings = Booking.objects.filter(
        property__realtor__agency=super_admin.agency,
        created_at__gte=start_date,
        created_at__lte=end_date
    ).count()
    
    cancelled_count = cancelled_bookings.count()
    cancellation_rate = (cancelled_count / total_bookings * 100) if total_bookings > 0 else 0
    
    # Группировка по инициатору
    by_initiator = cancelled_bookings.values('cancelled_by_role').annotate(
        count=Count('id')
    )
    
    # Группировка по причинам (гости)
    guest_cancellations = cancelled_bookings.filter(
        cancelled_by_role='guest'
    ).values('cancellation_reason').annotate(
        count=Count('id')
    ).order_by('-count')
    
    # Группировка по причинам (агентство)
    agency_cancellations = cancelled_bookings.filter(
        cancelled_by_role__in=['realtor', 'super_admin', 'superuser']
    ).values('cancellation_reason').annotate(
        count=Count('id')
    ).order_by('-count')
    
    # Рекомендации на основе анализа
    recommendations = []
    
    # Много отмен из-за цены
    price_cancellations = guest_cancellations.filter(
        cancellation_reason='found_cheaper'
    ).first()
    if price_cancellations and price_cancellations['count'] > cancelled_count * 0.2:
        recommendations.append({
            'type': 'warning',
            'title': 'Высокая доля отмен из-за цены',
            'message': 'Рекомендуем проанализировать ценообразование'
        })
    
    # Двойные бронирования
    double_bookings = agency_cancellations.filter(
        cancellation_reason='double_booking'
    ).exists()
    if double_bookings:
        recommendations.append({
            'type': 'critical',
            'title': 'Есть случаи двойного бронирования',
            'message': 'Проверьте синхронизацию календарей'
        })
    
    return {
        'total_cancelled': cancelled_count,
        'total_bookings': total_bookings,
        'cancellation_rate': round(cancellation_rate, 1),
        'by_initiator': by_initiator,
        'guest_reasons': guest_cancellations,
        'agency_reasons': agency_cancellations,
        'recommendations': recommendations,
        'details': cancelled_bookings
    }
```

**Постусловия:**
- Супер Админ понимает причины отмен
- Может принять меры для снижения отмен
- Видит проблемные зоны

---

### Сценарий 4.6: Загрузка объектов агентства

**Предусловия:**
- Супер Админ авторизован

**Основной поток (веб):**

1. Супер Админ выбирает "📊 Загрузка объектов"
2. Система показывает heat map:
   ```
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   
   📊 ЗАГРУЗКА ОБЪЕКТОВ
   
   Текущий месяц: Октябрь 2025
   Средняя загрузка: 54%
   
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   
   Heat Map календарь:
   
   Пн  Вт  Ср  Чт  Пт  Сб  Вс
   
   ██  ██  ██  ██  ███ ███ ███  Нед 1
   90% 85% 88% 82% 95% 98% 100%
   
   ███ ██  ██  ██  ██  ███ ███  Нед 2
   92% 87% 80% 78% 85% 96% 100%
   
   ██  █   ██  ██  ██  ███ ███  Нед 3
   75% 65% 78% 80% 82% 94% 98%
   
   ██  ██  █   █   ██  ███ ███  Нед 4
   80% 75% 55% 60% 78% 92% 95%
   
   Легенда:
   █  <40%  ██ 40-70%  ███ 70%+
   
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   
   📊 СТАТИСТИКА ПО ДНЯМ НЕДЕЛИ
   
   Понедельник:  █████████░ 84% (56/67 занято)
   Вторник:      ████████░░ 78% (52/67)
   Среда:        ███████░░░ 70% (47/67)
   Четверг:      ███████░░░ 70% (47/67)
   Пятница:      █████████░ 81% (54/67)
   Суббота:      ██████████ 95% (64/67)
   Воскресенье:  ██████████ 98% (66/67)
   
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   
   💡 ИНСАЙТЫ
   
   ✅ Выходные дни - максимальная загрузка
   ⚠️ Среда и четверг - самая низкая (70%)
   💡 Рассмотрите скидки на будние дни
   
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   
   🏠 ОБЪЕКТЫ С НИЗКОЙ ЗАГРУЗКОЙ (<40%)
   
   • Квартира #PR-245: 25% (Есиль)
   • Дом #PR-189: 35% (Сарыарка)
   • Квартира #PR-312: 38% (Алматы-2)
   
   [Детали по объектам] [📥 Экспорт]
   ```

**Постусловия:**
- Супер Админ видит паттерны загрузки
- Может оптимизировать ценообразование
- Может выявить проблемные объекты

---

## 5. Финансы агентства

### Сценарий 5.1: Доходы агентства по периодам

**Предусловия:**
- Супер Админ авторизован

**Основной поток (веб):**

1. Супер Админ заходит в "💰 Финансы"
2. Система показывает детализацию:
   ```
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   
   💰 ФИНАНСЫ АГЕНТСТВА
   
   Агентство: "Астана Элит Недвижимость"
   
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   
   📅 ВЫБЕРИТЕ ПЕРИОД
   
   [x] Неделя  [ ] Месяц  [ ] Год  [ ] Период
   
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   
   📊 ТЕКУЩАЯ НЕДЕЛЯ (21-27 окт)
   
   ┌────────────────────────────────────┐
   │ Общий доход:     1,285,000₸        │
   │ Средний чек:        19,500₸        │
   │ Бронирований:           66         │
   │ Завершено:              58         │
   │                                    │
   │ По сравнению с прошлой неделей:    │
   │ +8.5% ↑                            │
   └────────────────────────────────────┘
   
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   
   📈 ДИНАМИКА ПО ДНЯМ
   
   Дата        Брони   Доход
   
   21.10 Пн      8     152,000₸  ████████░
   22.10 Вт      9     175,500₸  █████████░
   23.10 Ср     10     195,000₸  ██████████
   24.10 Чт      8     156,000₸  ████████░
   25.10 Пт     11     214,500₸  ███████████
   26.10 Сб     12     234,000₸  ████████████
   27.10 Вс      8     158,000₸  ████████░
   
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   
   💼 ПО РИЕЛТОРАМ
   
   Асем Н.      15 бр   295,000₸  (23.0%)
   Марат Т.     12 бр   252,000₸  (19.6%)
   Алмаз С.     11 бр   231,000₸  (18.0%)
   Остальные    28 бр   507,000₸  (39.4%)
   
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   
   [Детальный отчет] [Экспорт] [Сравнить]
   ```

**Постусловия:**
- Супер Админ видит финансовую картину
- Может отслеживать динамику
- Может планировать бюджет

---

### Сценарий 5.2: Доходы по риелторам

**Предусловия:**
- Супер Админ авторизован

**Основной поток (веб):**

1. Супер Админ в разделе "Финансы" выбирает "👥 По риелторам"
2. Система показывает детализацию по каждому риелтору:
   ```
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   
   💼 ДОХОДЫ ПО РИЕЛТОРАМ
   
   Период: [Текущий месяц ▼]
   
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   
   ┌─────────────────────────────────────┐
   │ 👤 Асем Нурланова                   │
   │                                     │
   │ 💰 Общий доход: 890,000₸            │
   │ 📊 Доля: 18.3%                      │
   │ 📅 Бронирований: 45                 │
   │ 💵 Средний чек: 19,778₸             │
   │                                     │
   │ По объектам:                        │
   │ • 2-комн "Триумф": 575,000₸ (65%)   │
   │ • 1-комн "Сауран": 185,000₸ (21%)   │
   │ • Студия "Нурсая": 130,000₸ (14%)   │
   │ • Остальные: (9 объектов)           │
   │                                     │
   │ Динамика: +12% к прошлому месяцу    │
   │                                     │
   │ [Детали] [График] [Объекты]         │
   └─────────────────────────────────────┘
   
   [Аналогично для других риелторов...]
   
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   
   [Экспорт отчета] [Сравнить риелторов]
   ```

**Постусловия:**
- Супер Админ видит вклад каждого риелтора
- Может рассчитать премии/комиссии
- Может выявить неэффективных сотрудников

---

### Сценарий 5.3: Финансовый отчет агентства

**Предусловия:**
- Супер Админ авторизован

**Основной поток (веб):**

1. Супер Админ выбирает "📄 Финансовый отчет"
2. Выбирает период и параметры
3. Система генерирует подробный отчет:
   ```
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   
   📄 ФИНАНСОВЫЙ ОТЧЕТ
   
   Агентство: "Астана Элит Недвижимость"
   Период: Октябрь 2025 (01.10 - 31.10)
   Дата формирования: 27.10.2025 14:35
   
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   
   💰 ДОХОДЫ
   
   Общий доход:              4,850,000₸
   • Подтвержденные брони:   4,670,000₸
   • Завершенные брони:      4,450,000₸
   • В процессе оплаты:        180,000₸
   
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   
   📊 СТРУКТУРА ДОХОДОВ
   
   По типам объектов:
   • Квартиры (1-2 комн):  2,425,000₸ (50%)
   • Квартиры (3+ комн):   1,165,000₸ (24%)
   • Дома/коттеджи:        1,018,000₸ (21%)
   • Комнаты:                242,000₸ (5%)
   
   По районам:
   • Есиль:                2,182,500₸ (45%)
   • Алматы:               1,455,000₸ (30%)
   • Сарыарка:               970,000₸ (20%)
   • Байконыр:               242,500₸ (5%)
   
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   
   💳 МЕТОДЫ ОПЛАТЫ
   
   • Kaspi Pay:            3,880,000₸ (80%)
   • Наличные:               727,500₸ (15%)
   • Банковские карты:       242,500₸ (5%)
   
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   
   💸 РАСХОДЫ (если учитываются)
   
   • Комиссия платформы:     242,500₸ (5%)
   • Комиссия Kaspi:         116,400₸ (3%)
   • Маркетинг:               48,500₸ (1%)
   • Прочее:                  24,250₸ (0.5%)
   
   Итого расходов:           431,650₸ (8.9%)
   
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   
   📈 ЧИСТАЯ ПРИБЫЛЬ
   
   4,418,350₸ (91.1% от оборота)
   
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   
   📊 БРОНИРОВАНИЯ
   
   Всего броней:                    245
   • Подтверждено и оплачено:       198
   • Завершено успешно:             180
   • Отменено:                       12
   • В процессе:                     53
   
   Конверсия бронирований:        68.5%
   Средний чек:                19,796₸
   Средняя длительность:       3.2 ночи
   
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   
   [📥 Экспорт в XLSX] [📥 Экспорт в PDF]
   [📧 Отправить на email] [🖨️ Печать]
   ```

**Постусловия:**
- Супер Админ получил полный финансовый отчет
- Может использовать для бухгалтерии
- Может анализировать рентабельность

---

## 6. Экспорт отчетов

### Сценарий 6.1: Экспорт в XLSX

**Предусловия:**
- Супер Админ авторизован
- Есть данные для экспорта

**Основной поток (веб):**

1. Супер Админ в любом разделе статистики нажимает "📥 Экспорт в XLSX"
2. Система показывает настройки экспорта:
   ```
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   
   📥 ЭКСПОРТ В XLSX
   
   Отчет: Сравнение риелторов
   Период: Октябрь 2025
   
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   
   Что включить:
   
   [x] Общая сводка
   [x] Таблица риелторов
   [x] Графики (как изображения)
   [x] Детали по каждому риелтору
   [ ] Список всех бронирований
   [ ] Список всех объектов
   
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   
   Формат:
   
   (*) Один файл, несколько листов
   ( ) Отдельные файлы (ZIP)
   
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   
   [Отмена] [Сформировать]
   ```

3. Супер Админ нажимает "Сформировать"
4. Система генерирует XLSX файл:
   ```python
   def export_to_xlsx(super_admin, report_type, period, options):
       """Экспорт отчета в XLSX"""
       
       import openpyxl
       from openpyxl.styles import Font, Alignment, PatternFill
       from openpyxl.chart import BarChart, Reference
       
       wb = openpyxl.Workbook()
       
       # Лист 1: Сводка
       ws_summary = wb.active
       ws_summary.title = "Сводка"
       
       # Заголовок
       ws_summary['A1'] = f"Отчет: {report_type}"
       ws_summary['A1'].font = Font(size=16, bold=True)
       ws_summary['A2'] = f"Период: {period}"
       ws_summary['A3'] = f"Агентство: {super_admin.agency.name}"
       
       # Основные метрики
       row = 5
       ws_summary[f'A{row}'] = "Метрика"
       ws_summary[f'B{row}'] = "Значение"
       ws_summary[f'A{row}'].font = Font(bold=True)
       ws_summary[f'B{row}'].font = Font(bold=True)
       
       # ... добавление данных
       
       # Лист 2: Таблица риелторов
       ws_realtors = wb.create_sheet("Риелторы")
       
       headers = ['№', 'ФИО', 'Объектов', 'Бронирований', 
                  'Доход', 'Рейтинг', 'Загрузка']
       ws_realtors.append(headers)
       
       # Стилизация заголовков
       for cell in ws_realtors[1]:
           cell.font = Font(bold=True)
           cell.fill = PatternFill(start_color="366092", 
                                   end_color="366092", 
                                   fill_type="solid")
           cell.font = Font(color="FFFFFF", bold=True)
       
       # Получаем данные
       realtors_data = compare_realtors(super_admin, period)
       
       for idx, realtor in enumerate(realtors_data['realtors'], 1):
           ws_realtors.append([
               idx,
               f"{realtor.first_name} {realtor.last_name}",
               realtor.properties_count,
               realtor.bookings_count,
               float(realtor.revenue),
               round(realtor.avg_rating, 1),
               f"{round(realtor.occupancy_rate, 1)}%"
           ])
       
       # Автоширина колонок
       for column in ws_realtors.columns:
           max_length = 0
           column_letter = column[0].column_letter
           for cell in column:
               try:
                   if len(str(cell.value)) > max_length:
                       max_length = len(cell.value)
               except:
                   pass
           adjusted_width = (max_length + 2)
           ws_realtors.column_dimensions[column_letter].width = adjusted_width
       
       # График
       if options.get('include_charts'):
           chart = BarChart()
           chart.title = "Доход по риелторам"
           chart.x_axis.title = "Риелтор"
           chart.y_axis.title = "Доход (₸)"
           
           data = Reference(ws_realtors, min_col=5, min_row=1, 
                           max_row=len(realtors_data['realtors'])+1)
           cats = Reference(ws_realtors, min_col=2, min_row=2, 
                           max_row=len(realtors_data['realtors'])+1)
           
           chart.add_data(data, titles_from_data=True)
           chart.set_categories(cats)
           
           ws_realtors.add_chart(chart, "I2")
       
       # Сохранение
       filename = f"report_{report_type}_{period}_{timezone.now().strftime('%Y%m%d_%H%M%S')}.xlsx"
       filepath = os.path.join(settings.MEDIA_ROOT, 'exports', filename)
       
       os.makedirs(os.path.dirname(filepath), exist_ok=True)
       wb.save(filepath)
       
       return filepath
   ```

5. Файл скачивается автоматически

**Постусловия:**
- XLSX файл сгенерирован и скачан
- Содержит все запрошенные данные
- Форматирован и готов к использованию

---

### Сценарий 6.2: Экспорт в CSV

**Предусловия:**
- Супер Админ авторизован
- Есть данные для экспорта

**Основной поток:**

Аналогично XLSX, но формат CSV (более простой, для импорта в другие системы).

---

## 7. Уведомления и алерты

### Сценарий 7.1: Уведомления о критических событиях

**Предусловия:**
- Супер Админ авторизован
- Произошло критическое событие

**Примеры критических событий:**

1. **Новое бронирование** (опционально, можно отключить)
2. **Отмена бронирования** (всегда)
3. **Двойное бронирование** (критично)
4. **Низкая загрузка объекта** (предупреждение)
5. **Падение рейтинга** (предупреждение)
6. **Негативный отзыв** (предупреждение)

**Канал уведомлений:**
- Email
- Telegram (если подключен)
- Push-уведомления в браузере

**Пример уведомления (Telegram):**

```
⚠️ КРИТИЧЕСКОЕ СОБЫТИЕ

🔴 Двойное бронирование!

Объект: 2-комн "Триумф"
Риелтор: Асем Нурланова

Даты: 25-28 дек 2025

Конфликтующие брони:
• #BR-12458 (Марат К.)
• #BR-12459 (Айгуль С.)

Требуется немедленное решение!

[Перейти к деталям]
[Отменить одну из броней]
```

**Код отправки уведомления:**

```python
def notify_super_admin_critical(agency, event_type, details):
    """Отправка критического уведомления Супер Админу"""
    
    super_admin = CustomUser.objects.filter(
        agency=agency,
        role='super_admin',
        is_active=True
    ).first()
    
    if not super_admin:
        return
    
    # Email
    if super_admin.email:
        send_critical_email.delay(
            to_email=super_admin.email,
            event_type=event_type,
            details=details
        )
    
    # Telegram
    if super_admin.telegram_id:
        send_telegram_alert.delay(
            telegram_id=super_admin.telegram_id,
            event_type=event_type,
            details=details
        )
    
    # Web push
    if super_admin.push_subscription:
        send_push_notification.delay(
            subscription=super_admin.push_subscription,
            event_type=event_type,
            details=details
        )
```

---

### Сценарий 7.2: Еженедельный отчет

**Предусловия:**
- Супер Админ подписан на еженедельные отчеты

**Основной поток:**

1. Каждый понедельник в 9:00 система генерирует отчет за прошлую неделю
2. Отправляет на email Супер Админа
3. Дублирует в Telegram (если подключен)

**Пример отчета:**

```
📊 ЕЖЕНЕДЕЛЬНЫЙ ОТЧЕТ
Агентство: "Астана Элит Недвижимость"
Период: 21-27 октября 2025

━━━━━━━━━━━━━━━━━━━━━━━━━━━━

💰 ФИНАНСЫ
Доход: 1,285,000₸ (+8.5% к пред. неделе)
Средний чек: 19,470₸
Бронирований: 66

━━━━━━━━━━━━━━━━━━━━━━━━━━━━

👥 ЛУЧШИЕ РИЕЛТОРЫ
1. Асем Н. - 295,000₸ (15 броней)
2. Марат Т. - 252,000₸ (12 броней)
3. Алмаз С. - 231,000₸ (11 броней)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━

🏠 ЛУЧШИЕ ОБЪЕКТЫ
1. Дом "Алма" - 180,000₸
2. 2-комн "Триумф" - 175,000₸
3. 3-комн "Сауран" - 135,000₸

━━━━━━━━━━━━━━━━━━━━━━━━━━━━

⚠️ ТРЕБУЕТ ВНИМАНИЯ
• Квартира #PR-245: 0 броней
• Ержан А.: доход на 40% ниже среднего

━━━━━━━━━━━━━━━━━━━━━━━━━━━━

[Открыть полный отчет на сайте]
```

**Код генерации:**

```python
from celery import shared_task
from celery.schedules import crontab

@shared_task
def send_weekly_report():
    """Отправка еженедельного отчета всем Супер Админам"""
    
    super_admins = CustomUser.objects.filter(
        role='super_admin',
        is_active=True,
        weekly_reports_enabled=True
    )
    
    for super_admin in super_admins:
        # Генерируем отчет
        report_data = generate_weekly_report(super_admin)
        
        # Отправляем на email
        send_weekly_email.delay(
            to_email=super_admin.email,
            report_data=report_data
        )
        
        # Отправляем в Telegram
        if super_admin.telegram_id:
            send_weekly_telegram.delay(
                telegram_id=super_admin.telegram_id,
                report_data=report_data
            )

# Настройка в Celery Beat
app.conf.beat_schedule = {
    'send-weekly-reports': {
        'task': 'apps.reports.tasks.send_weekly_report',
        'schedule': crontab(day_of_week=1, hour=9, minute=0),
    },
}
```

---

## Итоговая таблица функций

| Функция | Пользователь | Риелтор | Супер Админ | Суперпользователь |
|---------|--------------|---------|-------------|-------------------|
| Поиск и бронирование | ✅ | ✅ | ✅ | ✅ |
| Управление своими объектами | ❌ | ✅ | ✅ | ✅ |
| Управление объектами риелторов | ❌ | ❌ | ✅ (своих) | ✅ (всех) |
| Управление бронированиями своих объектов | ❌ | ✅ | ✅ | ✅ |
| Управление бронированиями риелторов | ❌ | ❌ | ✅ (своих) | ✅ (всех) |
| Статистика своих объектов | ❌ | ✅ | ✅ | ✅ |
| Статистика агентства | ❌ | ❌ | ✅ | ✅ |
| Глобальная статистика | ❌ | ❌ | ❌ | ✅ |
| Управление риелторами | ❌ | ❌ | ✅ (своих) | ✅ (всех) |
| Управление агентствами | ❌ | ❌ | ❌ | ✅ |
| Финансы агентства | ❌ | ❌ | ✅ | ✅ |
| Глобальные финансы | ❌ | ❌ | ❌ | ✅ |
| Модерация объектов | ❌ | ❌ | ✅ (своих) | ✅ (всех) |
| Системные настройки | ❌ | ❌ | ❌ | ✅ |

---

## Заключение

Роль **Супер Админ** предоставляет руководителю агентства недвижимости все необходимые инструменты для эффективного управления командой риелторов:

✅ **Управление командой**
- Добавление/редактирование/деактивация риелторов
- Контроль эффективности каждого сотрудника
- Распределение задач и объектов

✅ **Контроль объектов**
- Просмотр всех объектов агентства
- Модерация новых объявлений
- Редактирование при необходимости

✅ **Мониторинг бронирований**
- Полный обзор всех броней
- Вмешательство в критических ситуациях
- Контроль качества обслуживания

✅ **Аналитика и отчетность**
- Подробная статистика по агентству
- Сравнение риелторов
- Финансовые отчеты
- Выявление проблемных зон

✅ **Финансовый контроль**
- Отслеживание доходов
- Расчет комиссий
- Планирование бюджета

---

**Дата:** 26 октября 2025  
**Версия:** 1.0  
**Статус:** ✅ Готово к разработке

**Следующий этап:** Роль "Суперпользователь"
